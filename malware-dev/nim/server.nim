import net
import std/parseopt
import parseutils


# would like to parse eventually, that is not today though
#var p = initOptParser("-ab -e:5 --foo --bar=20 file.txt")
for kind, key, value in getopt():
  echo "kind: ", kind
  case kind
  of cmdArgument:
    echo "Got arg with key: ", key

  of cmdLongOption, cmdShortOption:
    case key
    of "p":
      echo "Got arg 'p' with value: ", value
      var portNum: int  
      discard parseInt(value, portNum, 0)
      #let portNum: int = 5454

  of cmdEnd:
    discard


# Setting up the server params
let server: Socket = newSocket()
server.bindAddr(Port(portNum))

# Starting Server
server.listen()
echo "Server: started. Listening to new connections on port ", portNum, " ... "

var client: Socket = new(Socket)
server.accept(client)
stdout.writeLine("Server: client connected")

while true:
  stdout.write("> ")
  let command: string = stdin.readLine()
  
  client.send(command & "\n")
  let response: string = client.recvLine()
  echo "Server: Agent's Response: ", response


server.close()
stdout.writeLine("Server: closed.")

var consoleInput = readLine(stdin);
